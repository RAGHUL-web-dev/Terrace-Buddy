<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace - Terrace Buddy</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="font-sans bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav id="navbar" class="bg-white shadow-md">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center space-x-2">
                    <a href="dashboard.html" class="flex items-center space-x-2">
                        <i class="fas fa-seedling text-primary-600 text-2xl"></i>
                        <span class="text-xl font-bold text-gray-800">Terrace Buddy</span>
                    </a>
                </div>

                <!-- User Menu -->
                <div class="relative">
                    <button id="userMenuButton" 
                            class="flex items-center space-x-2 text-gray-700 hover:text-primary-600 font-medium">
                        <i class="fas fa-user-circle text-2xl"></i>
                        <span id="userName">Loading...</span>
                        <i class="fas fa-chevron-down text-sm"></i>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="dropdownMenu" 
                         class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 border">
                        <a href="dashboard.html" 
                           class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                           <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                        </a>
                        <a href="communities.html" 
                           class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                           <i class="fas fa-users mr-2"></i>Communities
                        </a>
                        <a href="marketplace.html" 
                           class="block px-4 py-2 text-gray-700 hover:bg-gray-100 bg-primary-50">
                           <i class="fas fa-store mr-2"></i>Marketplace
                        </a>
                        <a href="knowledge.html" 
                           class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                           <i class="fas fa-book mr-2"></i>Knowledge Hub
                        </a>
                        <a href="plants.html" 
                           class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                           <i class="fas fa-plant mr-2"></i>My Plants
                        </a>
                        <hr class="my-1">
                        <button id="logoutButton" 
                                class="block w-full text-left px-4 py-2 text-red-600 hover:bg-gray-100">
                           <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">Marketplace</h1>
                        <p class="text-gray-600">Buy, sell, or exchange gardening resources with local gardeners</p>
                    </div>
                    <button id="createListingBtn" 
                            class="mt-4 md:mt-0 bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition duration-300 flex items-center">
                        <i class="fas fa-plus mr-2"></i> List an Item
                    </button>
                </div>
                
                <!-- Search and Filter -->
                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                        <!-- Search -->
                        <div class="flex-1">
                            <div class="relative">
                                <input type="text" 
                                       id="marketplaceSearch"
                                       placeholder="Search items..."
                                       class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                            </div>
                        </div>
                        
                        <!-- Category Filter -->
                        <div>
                            <select id="categoryFilter" 
                                    class="w-full md:w-auto px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="">All Categories</option>
                                <option value="plants">Plants</option>
                                <option value="seeds">Seeds</option>
                                <option value="tools">Tools</option>
                                <option value="compost">Compost</option>
                                <option value="soil">Soil</option>
                                <option value="pots">Pots</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <!-- Type Filter -->
                        <div>
                            <select id="typeFilter" 
                                    class="w-full md:w-auto px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="">All Types</option>
                                <option value="sell">For Sale</option>
                                <option value="buy">Want to Buy</option>
                                <option value="exchange">For Exchange</option>
                            </select>
                        </div>
                        
                        <!-- Location Filter -->
                        <div>
                            <input type="text" 
                                   id="locationFilter"
                                   placeholder="Location"
                                   class="w-full md:w-auto px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        
                        <!-- Clear Filters -->
                        <button id="clearFilters" 
                                class="text-gray-600 hover:text-primary-600 font-medium">
                            Clear Filters
                        </button>
                    </div>
                    
                    <!-- Price Range -->
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Min Price</label>
                            <input type="number" 
                                   id="minPrice"
                                   placeholder="Min"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Max Price</label>
                            <input type="number" 
                                   id="maxPrice"
                                   placeholder="Max"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="border-b mb-8">
                <nav class="flex space-x-8">
                    <button id="allItemsTab" 
                            class="px-4 py-3 font-medium text-primary-600 border-b-2 border-primary-600">
                        All Items
                    </button>
                    <button id="myItemsTab" 
                            class="px-4 py-3 font-medium text-gray-600 hover:text-primary-600">
                        My Listings
                    </button>
                    <button id="savedItemsTab" 
                            class="px-4 py-3 font-medium text-gray-600 hover:text-primary-600">
                        Saved Items
                    </button>
                </nav>
            </div>
            
            <!-- Content Area -->
            <div>
                <!-- All Items Tab -->
                <div id="allItemsContent">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Item cards will be loaded here -->
                    </div>
                    
                    <!-- Loading State -->
                    <div id="itemsLoading" class="text-center py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading items...</p>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="noItems" class="text-center py-12 hidden">
                        <i class="fas fa-store text-gray-300 text-6xl mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">No items found</h3>
                        <p class="text-gray-600 mb-6">Try adjusting your search or filters</p>
                        <button id="createFirstListing" 
                                class="bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition duration-300">
                            List Your First Item
                        </button>
                    </div>
                </div>
                
                <!-- My Items Tab -->
                <div id="myItemsContent" class="hidden">
                    <div id="myItemsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    
                    <div id="noMyItems" class="text-center py-12 hidden">
                        <i class="fas fa-box-open text-gray-300 text-6xl mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">You haven't listed any items yet</h3>
                        <p class="text-gray-600 mb-6">List items to share with the community</p>
                        <button id="createMyFirstListing" 
                                class="bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition duration-300">
                            List Your First Item
                        </button>
                    </div>
                </div>
                
                <!-- Saved Items Tab -->
                <div id="savedItemsContent" class="hidden">
                    <div id="savedItemsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    
                    <div id="noSavedItems" class="text-center py-12 hidden">
                        <i class="fas fa-heart text-gray-300 text-6xl mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">No saved items</h3>
                        <p class="text-gray-600 mb-6">Save items you're interested in</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Create Listing Modal -->
    <div id="createListingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">List an Item</h3>
                    <button id="closeListingModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="createListingForm" class="space-y-6">
                    <!-- Basic Information -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="itemTitle" class="block text-sm font-medium text-gray-700 mb-2">
                                Title *
                            </label>
                            <input type="text" 
                                   id="itemTitle" 
                                   name="title"
                                   required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition duration-300"
                                   placeholder="e.g., Organic Tomato Seeds">
                            <div id="titleError" class="text-red-600 text-sm mt-1 hidden"></div>
                        </div>
                        
                        <div>
                            <label for="itemCategory" class="block text-sm font-medium text-gray-700 mb-2">
                                Category *
                            </label>
                            <select id="itemCategory" 
                                    name="category"
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="">Select Category</option>
                                <option value="plants">Plants</option>
                                <option value="seeds">Seeds</option>
                                <option value="tools">Tools</option>
                                <option value="compost">Compost</option>
                                <option value="soil">Soil</option>
                                <option value="pots">Pots</option>
                                <option value="other">Other</option>
                            </select>
                            <div id="categoryError" class="text-red-600 text-sm mt-1 hidden"></div>
                        </div>
                    </div>
                    
                    <!-- Type and Price -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="itemType" class="block text-sm font-medium text-gray-700 mb-2">
                                Listing Type *
                            </label>
                            <select id="itemType" 
                                    name="type"
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="">Select Type</option>
                                <option value="sell">For Sale</option>
                                <option value="buy">Want to Buy</option>
                                <option value="exchange">For Exchange</option>
                            </select>
                            <div id="typeError" class="text-red-600 text-sm mt-1 hidden"></div>
                        </div>
                        
                        <div id="priceField" class="hidden">
                            <label for="itemPrice" class="block text-sm font-medium text-gray-700 mb-2">
                                Price (₹) *
                            </label>
                            <input type="number" 
                                   id="itemPrice" 
                                   name="price"
                                   min="0"
                                   step="0.01"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition duration-300"
                                   placeholder="0.00">
                            <div id="priceError" class="text-red-600 text-sm mt-1 hidden"></div>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div>
                        <label for="itemDescription" class="block text-sm font-medium text-gray-700 mb-2">
                            Description *
                        </label>
                        <textarea id="itemDescription" 
                                  name="description"
                                  required
                                  rows="4"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition duration-300"
                                  placeholder="Describe your item in detail..."></textarea>
                        <div id="descriptionError" class="text-red-600 text-sm mt-1 hidden"></div>
                    </div>
                    
                    <!-- Images -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Images (Max 5)
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <div id="imagePreview" class="grid grid-cols-5 gap-2 mb-4"></div>
                            <input type="file" 
                                   id="itemImages"
                                   name="images"
                                   accept="image/*"
                                   multiple
                                   class="hidden"
                                   onchange="previewImages(this)">
                            <button type="button" 
                                    onclick="document.getElementById('itemImages').click()"
                                    class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-200 transition duration-300">
                                <i class="fas fa-camera mr-2"></i>Upload Images
                            </button>
                            <p class="text-sm text-gray-500 mt-2">Upload up to 5 images. Max 5MB each.</p>
                        </div>
                    </div>
                    
                    <!-- Location -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="itemCity" class="block text-sm font-medium text-gray-700 mb-2">
                                City
                            </label>
                            <input type="text" 
                                   id="itemCity" 
                                   name="city"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition duration-300"
                                   placeholder="Your city">
                        </div>
                        
                        <div>
                            <label for="itemState" class="block text-sm font-medium text-gray-700 mb-2">
                                State
                            </label>
                            <input type="text" 
                                   id="itemState" 
                                   name="state"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition duration-300"
                                   placeholder="Your state">
                        </div>
                    </div>
                    
                    <!-- Contact Method -->
                    <div>
                        <label for="contactMethod" class="block text-sm font-medium text-gray-700 mb-2">
                            Contact Method
                        </label>
                        <select id="contactMethod" 
                                name="contactMethod"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            <option value="in-app">In-app messaging</option>
                            <option value="email">Email</option>
                            <option value="phone">Phone</option>
                        </select>
                    </div>
                    
                    <!-- Message -->
                    <div id="createListingMessage" class="hidden p-3 rounded-lg text-center"></div>
                    
                    <!-- Submit Buttons -->
                    <div class="flex space-x-4">
                        <button type="submit" 
                                id="createListingSubmit"
                                class="flex-1 bg-primary-600 text-white py-3 rounded-lg font-semibold hover:bg-primary-700 transition duration-300">
                            List Item
                        </button>
                        <button type="button" 
                                id="cancelListing"
                                class="flex-1 bg-white text-gray-700 py-3 rounded-lg font-semibold border border-gray-300 hover:bg-gray-50 transition duration-300">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Item Detail Modal -->
    <div id="itemDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Item details will be loaded here -->
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400">© 2024 Terrace Buddy. Urban Gardening Made Easy.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="./js/utils.js"></script>
    <script src="./js/api.js"></script>
    <script src="./js/auth.js"></script>
    
    <script>
        let allItems = [];
        let myItems = [];
        let savedItems = [];
        let selectedImages = [];
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!checkAuthStatus()) {
                window.location.href = 'login.html';
                return;
            }
            
            // Load user data
            const user = getUserData();
            if (user && user.name) {
                document.getElementById('userName').textContent = user.name;
            }
            
            // Initialize user dropdown
            const userMenuButton = document.getElementById('userMenuButton');
            const dropdownMenu = document.getElementById('dropdownMenu');
            
            if (userMenuButton && dropdownMenu) {
                userMenuButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    dropdownMenu.classList.toggle('hidden');
                });
                
                document.addEventListener('click', function() {
                    dropdownMenu.classList.add('hidden');
                });
            }
            
            // Logout functionality
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', function() {
                    logoutUser();
                });
            }
            
            // Tab functionality
            const allItemsTab = document.getElementById('allItemsTab');
            const myItemsTab = document.getElementById('myItemsTab');
            const savedItemsTab = document.getElementById('savedItemsTab');
            
            allItemsTab.addEventListener('click', () => switchTab('allItems'));
            myItemsTab.addEventListener('click', () => switchTab('myItems'));
            savedItemsTab.addEventListener('click', () => switchTab('savedItems'));
            
            // Create listing modal
            const createListingBtn = document.getElementById('createListingBtn');
            const createListingModal = document.getElementById('createListingModal');
            const closeListingModal = document.getElementById('closeListingModal');
            const cancelListing = document.getElementById('cancelListing');
            
            createListingBtn.addEventListener('click', () => {
                createListingModal.classList.remove('hidden');
                resetListingForm();
            });
            
            closeListingModal.addEventListener('click', () => {
                createListingModal.classList.add('hidden');
            });
            
            cancelListing.addEventListener('click', () => {
                createListingModal.classList.add('hidden');
            });
            
            // Show price field when type is "sell"
            document.getElementById('itemType').addEventListener('change', function() {
                const priceField = document.getElementById('priceField');
                if (this.value === 'sell') {
                    priceField.classList.remove('hidden');
                } else {
                    priceField.classList.add('hidden');
                }
            });
            
            // Create listing form
            const createListingForm = document.getElementById('createListingForm');
            createListingForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const title = document.getElementById('itemTitle').value;
                const category = document.getElementById('itemCategory').value;
                const type = document.getElementById('itemType').value;
                const price = type === 'sell' ? document.getElementById('itemPrice').value : 0;
                const description = document.getElementById('itemDescription').value;
                const city = document.getElementById('itemCity').value;
                const state = document.getElementById('itemState').value;
                const contactMethod = document.getElementById('contactMethod').value;
                
                // Reset errors
                resetErrors();
                hideMessage('createListingMessage');
                
                // Validate
                let valid = true;
                
                if (!title) {
                    showError('titleError', 'Title is required');
                    valid = false;
                }
                
                if (!category) {
                    showError('categoryError', 'Category is required');
                    valid = false;
                }
                
                if (!type) {
                    showError('typeError', 'Listing type is required');
                    valid = false;
                }
                
                if (type === 'sell' && (!price || parseFloat(price) <= 0)) {
                    showError('priceError', 'Price is required for sale items');
                    valid = false;
                }
                
                if (!description) {
                    showError('descriptionError', 'Description is required');
                    valid = false;
                }
                
                if (!valid) return;
                
                // Prepare data
                const itemData = {
                    title,
                    category,
                    type,
                    description,
                    contactMethod
                };
                
                if (type === 'sell') {
                    itemData.price = parseFloat(price);
                }
                
                if (city || state) {
                    itemData.location = JSON.stringify({
                        city: city || '',
                        state: state || ''
                    });
                }
                
                // Add images
                if (selectedImages.length > 0) {
                    itemData.images = selectedImages;
                }
                
                try {
                    // Show loading
                    const submitBtn = document.getElementById('createListingSubmit');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
                    
                    // Create listing
                    const response = await api.createMarketplaceItem(itemData);
                    
                    if (response.success) {
                        showMessage('createListingMessage', 'Item listed successfully!', 'success');
                        
                        // Close modal and reload items after 1 second
                        setTimeout(() => {
                            createListingModal.classList.add('hidden');
                            createListingForm.reset();
                            selectedImages = [];
                            document.getElementById('imagePreview').innerHTML = '';
                            loadAllItems();
                            loadMyItems();
                        }, 1000);
                    } else {
                        showMessage('createListingMessage', response.message || 'Failed to list item', 'error');
                    }
                } catch (error) {
                    showMessage('createListingMessage', error.message || 'An error occurred', 'error');
                } finally {
                    const submitBtn = document.getElementById('createListingSubmit');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'List Item';
                }
            });
            
            // Search and filter
            const searchInput = document.getElementById('marketplaceSearch');
            const categoryFilter = document.getElementById('categoryFilter');
            const typeFilter = document.getElementById('typeFilter');
            const locationFilter = document.getElementById('locationFilter');
            const minPrice = document.getElementById('minPrice');
            const maxPrice = document.getElementById('maxPrice');
            const clearFiltersBtn = document.getElementById('clearFilters');
            
            const debouncedSearch = debounce(loadAllItems, 500);
            
            searchInput.addEventListener('input', debouncedSearch);
            categoryFilter.addEventListener('change', loadAllItems);
            typeFilter.addEventListener('change', loadAllItems);
            locationFilter.addEventListener('input', debouncedSearch);
            minPrice.addEventListener('input', debouncedSearch);
            maxPrice.addEventListener('input', debouncedSearch);
            
            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                categoryFilter.value = '';
                typeFilter.value = '';
                locationFilter.value = '';
                minPrice.value = '';
                maxPrice.value = '';
                loadAllItems();
            });
            
            // Create first listing buttons
            document.getElementById('createFirstListing').addEventListener('click', () => {
                createListingModal.classList.remove('hidden');
            });
            
            document.getElementById('createMyFirstListing').addEventListener('click', () => {
                createListingModal.classList.remove('hidden');
            });
            
            // Initial load
            await Promise.all([
                loadAllItems(),
                loadMyItems(),
                loadSavedItems()
            ]);
            
            switchTab('allItems');
        });
        
        function switchTab(tab) {
            // Update tab headers
            const tabs = ['allItemsTab', 'myItemsTab', 'savedItemsTab'];
            const contents = ['allItemsContent', 'myItemsContent', 'savedItemsContent'];
            
            tabs.forEach(tabId => {
                const tabElement = document.getElementById(tabId);
                tabElement.classList.remove('text-primary-600', 'border-primary-600', 'border-b-2');
                tabElement.classList.add('text-gray-600', 'hover:text-primary-600');
            });
            
            contents.forEach(contentId => {
                document.getElementById(contentId).classList.add('hidden');
            });
            
            // Activate selected tab
            document.getElementById(`${tab}Tab`).classList.add('text-primary-600', 'border-primary-600', 'border-b-2');
            document.getElementById(`${tab}Content`).classList.remove('hidden');
        }
        
        async function loadAllItems() {
            const loadingElement = document.getElementById('itemsLoading');
            const noItemsElement = document.getElementById('noItems');
            const itemsContainer = document.querySelector('#allItemsContent .grid');
            
            loadingElement.classList.remove('hidden');
            noItemsElement.classList.add('hidden');
            itemsContainer.innerHTML = '';
            
            try {
                // Get filters
                const filters = {};
                const search = document.getElementById('marketplaceSearch').value;
                const category = document.getElementById('categoryFilter').value;
                const type = document.getElementById('typeFilter').value;
                const location = document.getElementById('locationFilter').value;
                const min = document.getElementById('minPrice').value;
                const max = document.getElementById('maxPrice').value;
                
                if (search) filters.search = search;
                if (category) filters.category = category;
                if (type) filters.type = type;
                if (location) filters.location = location;
                if (min) filters.minPrice = min;
                if (max) filters.maxPrice = max;
                
                // Fetch items
                const response = await api.getMarketplaceItems(filters);
                
                if (response.success) {
                    allItems = response.items || [];
                    
                    if (allItems.length === 0) {
                        noItemsElement.classList.remove('hidden');
                    } else {
                        renderItemCards(allItems, itemsContainer);
                    }
                }
            } catch (error) {
                console.error('Error loading items:', error);
                showNotification('Failed to load items', 'error');
            } finally {
                loadingElement.classList.add('hidden');
            }
        }
        
        async function loadMyItems() {
            const noItemsElement = document.getElementById('noMyItems');
            const itemsContainer = document.getElementById('myItemsList');
            
            noItemsElement.classList.add('hidden');
            itemsContainer.innerHTML = '';
            
            try {
                const response = await api.getMyMarketplaceItems();
                
                if (response.success) {
                    myItems = response.items || [];
                    
                    if (myItems.length === 0) {
                        noItemsElement.classList.remove('hidden');
                    } else {
                        renderItemCards(myItems, itemsContainer, true);
                    }
                }
            } catch (error) {
                console.error('Error loading my items:', error);
                showNotification('Failed to load your items', 'error');
            }
        }
        
        async function loadSavedItems() {
            const noItemsElement = document.getElementById('noSavedItems');
            const itemsContainer = document.getElementById('savedItemsList');
            
            noItemsElement.classList.add('hidden');
            itemsContainer.innerHTML = '';
            
            try {
                // Load saved items from localStorage (in real app, fetch from API)
                savedItems = JSON.parse(localStorage.getItem('savedItems') || '[]');
                
                if (savedItems.length === 0) {
                    noItemsElement.classList.remove('hidden');
                } else {
                    renderItemCards(savedItems, itemsContainer, false, true);
                }
            } catch (error) {
                console.error('Error loading saved items:', error);
            }
        }
        
        function renderItemCards(items, container, isMyItem = false, isSaved = false) {
            container.innerHTML = '';
            
            items.forEach(item => {
                const card = createItemCard(item, isMyItem, isSaved);
                container.appendChild(card);
            });
        }
        
        function createItemCard(item, isMyItem = false, isSaved = false) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-md overflow-hidden hover-card';
            card.dataset.id = item._id;
            
            // Get first image or placeholder
            const imageUrl = item.images && item.images.length > 0 
                ? item.images[0] 
                : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2YwZmRmNCIvPjx0ZXh0IHg9IjIwMCIgeT0iMTUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMyMmM1NWUiPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
            
            // Format price
            const price = item.type === 'sell' 
                ? `₹${item.price.toFixed(2)}` 
                : item.type === 'buy' 
                    ? 'Want to Buy' 
                    : 'For Exchange';
            
            // Status badge
            const statusColors = {
                available: 'bg-green-100 text-green-700',
                pending: 'bg-yellow-100 text-yellow-700',
                sold: 'bg-red-100 text-red-700',
                exchanged: 'bg-blue-100 text-blue-700'
            };
            
            card.innerHTML = `
                <div class="relative">
                    <img src="${imageUrl}" 
                         alt="${item.title}" 
                         class="w-full h-48 object-cover cursor-pointer view-item-btn">
                    ${!isMyItem ? `
                        <button class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full shadow-md flex items-center justify-center text-gray-600 hover:text-red-500 save-item-btn">
                            <i class="fas fa-heart${isSaved ? '' : '-o'}"></i>
                        </button>
                    ` : ''}
                    ${item.status && item.status !== 'available' ? `
                        <div class="absolute top-2 left-2">
                            <span class="px-2 py-1 rounded text-xs font-medium ${statusColors[item.status] || 'bg-gray-100 text-gray-700'}">
                                ${item.status}
                            </span>
                        </div>
                    ` : ''}
                </div>
                <div class="p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-gray-900 truncate">${item.title}</h3>
                        <span class="bg-primary-100 text-primary-700 px-2 py-1 rounded text-xs font-medium whitespace-nowrap">
                            ${price}
                        </span>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-3 line-clamp-2">${item.description}</p>
                    
                    <div class="flex items-center justify-between text-sm text-gray-500">
                        <div class="flex items-center">
                            <i class="fas fa-tag mr-1"></i>
                            <span class="capitalize">${item.category}</span>
                        </div>
                        <div>
                            ${item.location && item.location.city ? `
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                <span>${item.location.city}</span>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${isMyItem ? `
                        <div class="mt-4 flex space-x-2">
                            <button class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 edit-item-btn">
                                Edit
                            </button>
                            <button class="flex-1 bg-red-100 text-red-700 py-2 rounded-lg text-sm font-medium hover:bg-red-200 delete-item-btn">
                                Delete
                            </button>
                        </div>
                    ` : `
                        <button class="mt-4 w-full bg-primary-600 text-white py-2 rounded-lg font-medium hover:bg-primary-700 transition duration-300 view-item-btn">
                            View Details
                        </button>
                    `}
                </div>
            `;
            
            // Add event listeners
            const viewButtons = card.querySelectorAll('.view-item-btn');
            viewButtons.forEach(btn => {
                btn.addEventListener('click', () => showItemDetail(item._id));
            });
            
            if (!isMyItem) {
                const saveBtn = card.querySelector('.save-item-btn');
                saveBtn.addEventListener('click', () => toggleSaveItem(item, card));
            }
            
            if (isMyItem) {
                const editBtn = card.querySelector('.edit-item-btn');
                const deleteBtn = card.querySelector('.delete-item-btn');
                
                editBtn.addEventListener('click', () => editItem(item._id));
                deleteBtn.addEventListener('click', () => deleteItem(item._id, card));
            }
            
            return card;
        }
        
        async function showItemDetail(itemId) {
            try {
                const response = await api.getMarketplaceItem(itemId);
                
                if (response.success) {
                    const item = response.item;
                    const modal = document.getElementById('itemDetailModal');
                    const modalContent = modal.querySelector('div');
                    
                    // Format price
                    const price = item.type === 'sell' 
                        ? `₹${item.price.toFixed(2)}` 
                        : item.type === 'buy' 
                            ? 'Want to Buy' 
                            : 'For Exchange';
                    
                    modalContent.innerHTML = `
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-900 mb-2">${item.title}</h3>
                                    <div class="flex items-center space-x-2">
                                        <span class="bg-primary-100 text-primary-700 px-3 py-1 rounded text-sm font-medium">
                                            ${price}
                                        </span>
                                        <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm font-medium capitalize">
                                            ${item.category}
                                        </span>
                                        <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm font-medium">
                                            ${item.type}
                                        </span>
                                    </div>
                                </div>
                                <button id="closeDetailModal" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <!-- Images -->
                            <div class="mb-6">
                                ${item.images && item.images.length > 0 ? `
                                    <div class="grid grid-cols-4 gap-2 mb-4">
                                        ${item.images.map((img, index) => `
                                            <img src="${img}" 
                                                 alt="${item.title} - Image ${index + 1}" 
                                                 class="w-full h-32 object-cover rounded-lg cursor-pointer"
                                                 onclick="viewImage('${img}')">
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Description -->
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-900 mb-2">Description</h4>
                                <p class="text-gray-700 whitespace-pre-line">${item.description}</p>
                            </div>
                            
                            <!-- Seller Info -->
                            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                <h4 class="font-bold text-gray-900 mb-3">Seller Information</h4>
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 rounded-full bg-primary-100 flex items-center justify-center">
                                        <i class="fas fa-user text-primary-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">${item.seller?.name || 'Unknown'}</p>
                                        <p class="text-sm text-gray-600">${item.seller?.email || ''}</p>
                                    </div>
                                </div>
                                ${item.seller?.location ? `
                                    <div class="mt-3 flex items-center text-gray-600">
                                        <i class="fas fa-map-marker-alt mr-2"></i>
                                        <span>${item.seller.location.city || ''}${item.seller.location.state ? `, ${item.seller.location.state}` : ''}</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Contact -->
                            <div class="border-t pt-6">
                                <h4 class="font-bold text-gray-900 mb-4">Contact Seller</h4>
                                <div class="flex space-x-4">
                                    <button class="flex-1 bg-primary-600 text-white py-3 rounded-lg font-medium hover:bg-primary-700 transition duration-300">
                                        <i class="fas fa-comment mr-2"></i>Send Message
                                    </button>
                                    ${item.contactMethod === 'phone' && item.seller?.phone ? `
                                        <a href="tel:${item.seller.phone}" 
                                           class="flex-1 bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 transition duration-300 text-center">
                                           <i class="fas fa-phone mr-2"></i>Call Seller
                                        </a>
                                    ` : ''}
                                    ${item.contactMethod === 'email' && item.seller?.email ? `
                                        <a href="mailto:${item.seller.email}" 
                                           class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition duration-300 text-center">
                                           <i class="fas fa-envelope mr-2"></i>Email Seller
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Show modal
                    modal.classList.remove('hidden');
                    
                    // Close button
                    modal.querySelector('#closeDetailModal').addEventListener('click', () => {
                        modal.classList.add('hidden');
                    });
                }
            } catch (error) {
                console.error('Error loading item details:', error);
                showNotification('Failed to load item details', 'error');
            }
        }
        
        function toggleSaveItem(item, cardElement) {
            let savedItems = JSON.parse(localStorage.getItem('savedItems') || '[]');
            const isSaved = savedItems.some(saved => saved._id === item._id);
            
            if (isSaved) {
                // Remove from saved
                savedItems = savedItems.filter(saved => saved._id !== item._id);
                showNotification('Item removed from saved', 'info');
            } else {
                // Add to saved
                savedItems.push(item);
                showNotification('Item saved', 'success');
            }
            
            localStorage.setItem('savedItems', JSON.stringify(savedItems));
            
            // Update button icon
            const saveBtn = cardElement.querySelector('.save-item-btn i');
            if (isSaved) {
                saveBtn.classList.remove('fa-heart');
                saveBtn.classList.add('fa-heart-o');
            } else {
                saveBtn.classList.remove('fa-heart-o');
                saveBtn.classList.add('fa-heart');
            }
            
            // Reload saved items tab if active
            if (document.getElementById('savedItemsTab').classList.contains('text-primary-600')) {
                loadSavedItems();
            }
        }
        
        async function editItem(itemId) {
            showNotification('Edit feature coming soon!', 'info');
        }
        
        async function deleteItem(itemId, cardElement) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            try {
                const response = await api.deleteMarketplaceItem(itemId);
                
                if (response.success) {
                    cardElement.remove();
                    showNotification('Item deleted successfully', 'success');
                    
                    // Reload lists
                    loadAllItems();
                    loadMyItems();
                } else {
                    showNotification(response.message || 'Failed to delete item', 'error');
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showNotification('Failed to delete item', 'error');
            }
        }
        
        function previewImages(input) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            selectedImages = [];
            
            if (input.files.length > 5) {
                showNotification('Maximum 5 images allowed', 'error');
                input.value = '';
                return;
            }
            
            Array.from(input.files).forEach((file, index) => {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(`Image ${index + 1} is too large (max 5MB)`, 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'w-full h-20 object-cover rounded-lg';
                    preview.appendChild(img);
                    
                    // Store file for upload
                    selectedImages.push(file);
                }
                reader.readAsDataURL(file);
            });
        }
        
        function resetListingForm() {
            document.getElementById('createListingForm').reset();
            selectedImages = [];
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('priceField').classList.add('hidden');
            resetErrors();
            hideMessage('createListingMessage');
        }
        
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.remove('hidden');
            }
        }
        
        function resetErrors() {
            const errorElements = document.querySelectorAll('[id$="Error"]');
            errorElements.forEach(el => {
                el.textContent = '';
                el.classList.add('hidden');
            });
        }
        
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = 'p-3 rounded-lg text-center';
                
                if (type === 'success') {
                    element.classList.add('bg-green-100', 'text-green-700');
                } else if (type === 'error') {
                    element.classList.add('bg-red-100', 'text-red-700');
                }
                
                element.classList.remove('hidden');
            }
        }
        
        function hideMessage(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('hidden');
            }
        }
        
        // Image viewer function
        window.viewImage = function(src) {
            const viewer = document.createElement('div');
            viewer.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center';
            viewer.innerHTML = `
                <div class="relative max-w-4xl max-h-[90vh]">
                    <img src="${src}" class="max-w-full max-h-[90vh] object-contain">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="absolute top-4 right-4 text-white text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(viewer);
        };
        
        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>